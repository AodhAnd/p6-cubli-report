\chapter{Angle Measurement with Built-in Sensors}\label{chap:CompFilter}
It is a goal to get the Cubli setup to balance the frame in an upright position independently of the baseplate orientation within the possible angle of rotation.

As described in \secref{sec:Sensors} there are two IMUs mounted on the frame of the Cubli (shown on \figref{Cubli-6}). They can be used to achieve this goal since they only depend on the absolute angle and they can also be used in the full Cubli.

\section{Angle Calculations from the IMUs}
The angular position of the Cubli can be calculated using the accelerometer, the gyroscope or combining both. In this section each of the options is describe and analyzed.

\subsection{Angle from the Accelerometer}
The accelerometer measures linear acceleration, and if the accelerometer is attached to a object that does not accelerate with respect to the Earth, the accelerometer will measure the gravitational acceleration. This can be used to determine the orientation of the accelerometer sensor with respect to the Earth \cite{JWarren}.\\
The accelerometers used with the Cubli setup have 3-axis detection as described in \secref{sec:Sensors}. To determine the angle of the frame (\si{\theta_F}) with the accelerometer it is needed to get the measurements from two of the three axes. The two measurements needed are the ones in line with the frames movement direction, based on the way the IMU is mounted, as shown in \figref{accelerometer}. 
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{figures/accelerometer}
	\caption{Position of the IMU on the setup. It is rotatet by \si{\frac{\pi}{4}} in relation to the angle \si{\theta_F} Shown here is the orientation of the accelerometer in relation to the Cubli frame. On the IMU are the components of the acceleration vector shown. In case of no movement by the frame these are the components of the gravitational acceleration vector.}
	\label{accelerometer}
\end{figure}\vspace{-5mm}
%
Based on the markings on the IMU, those are the x- and y-axis components of the linear acceleration. Taking the two axis measurements shown in figure \ref{accelerometer} the angle can be found using \eqref{accelAngle} \cite{CFisher}. 
%
\begin{flalign}
	\eq{accel\_\theta_{F}} {\arctan\left(\frac{y}{x}\right) + \frac{\pi}{4}} \unit{rad} 
	\label{accelAngle}
\end{flalign}
%
The offset (\si{\frac{\pi}{4}}) is added because the IMU is mounted with a \si{\frac{\pi}{4}} rotation compared to the orientation of the frame.\\
A test to measure the angle of the frame with the accelerometer is performed, and with the purpose to compare it to data from the potentiometer taken at the same time. The data from both sensors is read at the same time, to make it possible to compare the accelerometer to the potentiometer to determine if the accelerometer can be used instead of the potentiometer.\\
A comparison of the two measurements is shown in \figref{angleAcc}. The accelerometer angle (\si{accel\_\theta_{F}}) is found by taking the x- and y-axis components and calculating the angle with \eqref{accelAngle}.
The data from the test can be found in  \appref{app:IMUMeasurementsAppendix}. 
%
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.65]{figures/angleAcc}
	\caption{The graph shows a comparison of the angle of the frame measured by the potentiometer(orange) and the same angle found with the accelerometer(blue). The accelerometer angle is calculated based on the measurement data from the x- and y-axis component (\appref{app:IMUMeasurementsAppendix})}
	\label{angleAcc}
\end{figure}\vspace{-5mm}
%
The measurements of the potentiometer and accelerometer are both showing the Cubli frame in the same position. The measurement from the accelerometer has a lot more noise than the potentiometer.

While the Cubli setup tries to balance the frame, the IMU mounted on the top of it will move along with the frame and the spikes seen on the calculated angle data from the accelerometer data in \figref{angleAcc} are because the IMU is moving and the acceleration from this creates a disturbance on the measurement of the gravitational acceleration \cite{JWarren}.\\
A way to minimize this disturbance would be to move the IMU as close as possible to the point of rotation. This way the accelerometer is still able to see the angle of the frame, but the distance it is moved is shorter and the acceleration will be smaller. \fxnote{we didnt do this because we would have to remount the sensor and create a new mount. how to best word that?, B}

\subsection{Angle from the Gyroscope}
The angle of the frame can be found with the gyroscope by integrating the angular velocity measured by the gyroscope on the axis aligned with the direction of motion of the frame as shown in \figref{cubliMechanical}.
\begin{flalign}
	\eq{gyro\_\theta_{F}[n]} {\int_{0}^{n\cdot \Delta T} \omega_{F} \, \mathrm{d}t}
	\label{accelGyro}
\end{flalign}
\hspace{6mm} Where:\\
\begin{tabular}{ p{1cm} l l l}
	& \si{\omega_{F}}			& is the angular velocity of the frame     \\                       
\end{tabular} 
\\
The problem with the data from the gyro is an accumulating error which is caused by the integration done to convert angular velocity into an usable angle. It is also known that the gyros will exhibit a drifting error when experiencing small and slow movement \cite{JWarren}. These problems can be observed in \figref{angleGyro}.
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.65]{figures/angleGyro}
	\caption{Angular position calculation with the data of the gyroscope}
	\label{angleGyro}
\end{figure}\vspace{-5mm}
%The problem with the data from the gyro is it will exhibit a drifting error when experiencing no movement \cite{JWarren} and since the angular velocity has to be integrated to get the angel there will be an accumulation error. 

Assuming that the drift is constant, a way to minimize its influence on the data would be to do a test while keeping the frame motionless. The inclination of the slope from the data graph multiplied with the samplingtime is then the offset that has to be subtracted from each measurement.



\subsection{Data Fusing with Complementary Filter}
In order to filter the drift of the gyroscope and the disturbance errors of the accelerometer a complementary filter can be used to combine both measurements from the IMU mounted on the Cubli frame. This is done with the goal to get a more reliable angle measurement for both when the frame is moving and when its standing still in the equilibrium point.\\
The two angle measurements of the IMU are sent through a filter and then summed in order to get an angle of the Cubli's frame. When the frame is moving fast it is better to rely on the gyroscope data, and when the frame is moving slowly or not at all it is better to rely on the accelerometer data \cite{PGui}.

\begin{figure}[H]
	\input{figures/complementaryFilterBlockDiagram.tikz}
	\centering
	\caption{Block diagram of the complementary filter setup used with the IMU on the Cubli}
	\label{blockDrawingComplementaryFilter}
\end{figure}

The filter for the IMU is designed as shown in \figref{blockDrawingComplementaryFilter} with a low pass filter on the measurements from the accelerometer, and an integration followed by a high pass filter on the measurements from the gyroscope \cite{OlliW}. \cite{PGui}
\begin{flalign}
	\eq{\theta_{F}} {\frac{1}{ 1 + \tau \cdot s} \cdot accel\_\theta_{F}}   &\\
	\eq{\theta_{F}} {\frac{\tau \cdot s}{ 1 + \tau \cdot s} \cdot \frac{1}{s} \cdot gyro\_\dot{\theta}_{F}}	&
	\label{complementaryBlockFilters}
\end{flalign}
Combining the two equations yields \eqref{complementaryCombinedFilter}
\begin{flalign}
	\eq{\theta_{F}} {\frac{1}{ 1 + \tau \cdot s} \cdot accel\_\theta_{F} + \frac{\tau \cdot s}{ 1 + \tau \cdot s} \cdot \frac{1}{s} \cdot gyro\_\dot{\theta}_{F} = \frac{accel\_\theta_{F} + \tau \cdot gyro\_\dot{\theta}_{F}}{1 + \tau \cdot s}} &
	\label{complementaryCombinedFilter}
\end{flalign}
The \si{\tau} is the cut-off frequency of the two filters. Changing this constant decides how much the two different sensor measurements weight in on the combined angle.
 
\section{Discretization of the Complementary Filter} 
In oder to use the complementary filter on the Cubli it needs to be discretized. This is done with the bilinear transformation method where \si{s = \frac{2}{\Delta T}\cdot \frac{1 - z^{-1}}{1 + z^{-1}}}, with a sample time of 
Rewriting \eqref{complementaryCombinedFilter} yields
\begin{flalign}
 	\eq{\theta_{F}} {\frac{1}{1 + \tau \cdot s} \cdot (accel\_\theta_{F} + \tau \cdot gyro\_\dot{\theta}_{F})} &
 	\label{discreteComplementaryFilter1}
\end{flalign}
If s is replaced by its discrete expression, the difference equation can be derived.
\begin{flalign}
  	\eq{\theta_{F}} {\frac{1}{1 + \tau \cdot \frac{2}{\Delta T}\cdot \frac{1 - z^{-1}}{1 + z^{-1}}} \cdot (accel\_\theta_{F} + \tau \cdot gyro\_\dot{\theta}_{F})} &
  	\label{discreteComplementaryFilter2}
\end{flalign}
%
%\begin{flalign}
%  	\eq{\Updownarrow \theta_{F}} {\frac{\Delta T \cdot (1 + z^{-1})}{\Delta T \cdot (1 + z^{-1})+2\cdot (1 - z^{-1})\cdot \tau} \cdot (accel\_\theta_{F} + \tau \cdot gyro\_\dot{\theta}_{F})}
%  	\label{discreteComplementaryFilter3}
%\end{flalign}
  %
\begin{flalign}
   	\eq{\theta_{F}} {\frac{\Delta T + \Delta T \cdot z^{-1}}{(2\cdot \tau + \Delta T) - (2\tau - \Delta T)\cdot z^{-1}} \cdot (accel\_\theta_{F} + \tau \cdot gyro\_\dot{\theta}_{F})} &
\end{flalign}\label{discreteComplementaryFilter4}
%
%\begin{flalign}
%	\eq{\Updownarrow \theta_{F} \cdot ((2\cdot \tau + \Delta T) - (2\tau - \Delta T)\cdot z^{-1})} {\Delta T + \Delta T \cdot z^{-1} \cdot (accel\_\theta_{F} + \tau \cdot gyro\_\dot{\theta}_{F})} &
%\end{flalign}\label{discreteComplementaryFilter5}
%%
\begin{flalign}
	\eqOne{\theta_{F}[n] \cdot (2\cdot \tau + \Delta T) - \theta_{F}[n-1] \cdot (2\tau - \Delta T)} {\Delta T \cdot (accel\_\theta_{F}[n] + accel\_\theta_{F}[n-1]} 
	\eqTwo{ + \tau \cdot gyro\_\dot{\theta}_{F}[n] + \tau \cdot gyro\_\dot{\theta}_{F}[n+1])} 
	\label{discreteComplementaryFilter6}
\end{flalign}
%  
\begin{flalign}
	\eqOne{\theta_{F}[n]}{\frac{(2\cdot \tau + \Delta T)}{2\cdot \tau + \Delta } \cdot \theta_{F}[n-1] + \frac{\Delta T}{2\cdot \tau + \Delta T} \cdot accel\_\theta_{F}[n] + \frac{\Delta T}{2\cdot \tau + \Delta T} \cdot accel\_\theta_{F}[n-1]} 
	\eqTwo{ + \frac{\Delta T \cdot \tau}{2\cdot \tau + \Delta T} \cdot gyro\_\dot{\theta}_{F}[n] + \frac{\Delta T \cdot \tau}{2\cdot \tau + \Delta T} \cdot gyro\_\dot{\theta}_{F}[n-1]} 
	\label{discreteComplementaryFilter7}
\end{flalign}
%

Implementing \eqref{discreteComplementaryFilter7} yields to following piece of code. \fxnote{USE the current form in the controller code file}
%
%\begin{lstlisting}[caption  = {Code for the implementation of the complementary filter in C\texttt{++}},
%label    = codeCompFilter ]
%/**
%*  delta_T is the sampling time = 0.01 s
%*  tau is the cut-off frequency of the low and high pass filters
%*/
%theta_f[n] = ((2*tau-delta_T) / (2*tau+delta_T)) * theta[n-1] + 
%	(delta_T / (2*tau+delta_T)) * (acc_theta[n] + tau * gyro_thetaDot[n] + 
%	acc_theta[n-1] + tau * gyro_thetaDot[n-1]) 
%\end{lstlisting}

\begin{lstlisting}[caption  = {Code for the implementation of the complementary filter in C\texttt{++}},
label    = codeCompFilter ]
//---------------------- IMU --------------------------//

const double acc_off = 0.84;  	// accel meass offset
const double tau = 0.5399;	// cut-off for the complementary filter

static double acc_angle[2]={atan(accY1/accX1) + acc_off,0},
gyro_angle[2]={gyroRads1,gyroRads1},
comp_angle[2]={acc_angle[0],0};

// Set old measurement data
acc_angle[1] = acc_angle[0];
gyro_angle[1] = gyro_angle[0];
gyro_angle[0] = gyroRads1;
comp_angle[1] = comp_angle[0];

// Get angle from accel axis measurements
acc_angle[0] = atan(accY1/accX1) + acc_off;

//Complementary equation using Tustin
const double K1 = (2*tau-Ts)/(2*tau+Ts);
const double K2 = Ts/(2*tau + Ts);
comp_angle[0] = K1*comp_angle[1] + K2*(acc_angle[0] + acc_angle[1] + tau*gyro_angle[0] + tau*gyro_angle[1]);
\end{lstlisting}

\section{Calculation of the Cut-off Frequency}
The cut-off frequency for the filters can be determined by using SensTool and the data obtained through the test detailed in \appref{app:IMUMeasurementsAppendix}. 

The toolbox uses the data form the potentiometer as the real output of the system, the data from the IMUs as the input and the modeling of the system is done through \eqref{discreteComplementaryFilter7}. With this data it can find the optimal value for \si{\tau} based on the difference between the angle measured by the potentiometer and an angle calculated from accelerometer and gyroscope measurements done during the same test.

The final fit can be seen in \figref{filterSensTool} and it gives an optimal \si{\tau\ =\ 0,5399\ s}. This results in a cutting frequency for the filter equal to \si{11,63\ rad \cdot s^{-1}}.
%
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.65]{figures/filterSensTool}
	\caption{Final result of the complementary filter compared with the data from the potentiometer}
	\label{filterSensTool}
\end{figure}\vspace{-5mm}
%