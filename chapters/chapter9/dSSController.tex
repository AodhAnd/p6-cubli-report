\section{Design of a Controller in State-Space}\label{sec:SSController}
The aim of the controller is to maintain the system in equilibrium position, which means that the reference for each state is always. 

With this assumption a new state matrix can be created such its poles are placed in the LHP and then the system becomes stable.This is done by adding a state feedback and a \si{3x1} gain matrix to the whole system, as seen in \figref{SSBlocksFeedback}.
%
\begin{figure}[H]
	\input{figures/SSBlockDiagramFeedback.tikz}
	\centering
	\caption{Block diagram with the state feedback}
\end{figure} \label{SSBlocksFeedback}
%
This new configuration gives a new equation for \si{\dot x}:
%
\begin{flalign}
	\eq{\dot{x}(t)}{(A-BK) \cdot x(t)}
	\label{xDotK} 
\end{flalign}
%
The objective is to find K such the eigenvalues of \si{A-BK} are placed at the LHP. This gain matrix can be found using the Matlab command K = place(A,B,P), where P is a vector containing the desire position of the new poles.

To choose the position of this poles two simulations are made for different values. In the first one the Cubli starts from equilibrium and a disturbance torque is applied while in the second one it starts from an initial angle different from 0 rad and with an initial acceleration.

\begin{minipage}{\linewidth}
	\begin{minipage}{0.45\linewidth}
		\begin{figure}[H]
			\includegraphics[scale=.5]{figures/disturbanceStateSpace}
			\centering
			\captionsetup{justification=centering}
			\captionof{figure}{Response of the system to a disturbance with different locations of poles}
			\label{disturbanceStateSpace}
		\end{figure}
	\end{minipage}
	\hspace{0.03\linewidth}
	\begin{minipage}{0.45\linewidth}
		\begin{figure}[H]\vspace{4mm}
			\includegraphics[scale=.5]{figures/catchingStateSpace}
			\centering
			\captionsetup{justification=centering}
			\captionof{figure}{Response starting from 0.2 rad and an initial acceleration with different locations of poles}
			\label{catchingStateSpace}
		\end{figure}
	\end{minipage}
\end{minipage}

The final combination of poles is -6, -7 and -10, which gives the yellow responses in \figref{disturbanceStateSpace} and \figref{catchingStateSpace}. This seems a good option since its response is quite fast but with not too much overshoot. The gain matrix for this combination results in the following:
%
\begin{equation}  \label{controllerSS}
	K = 
	\begin{bmatrix}
		-2,3021 & -0,227 & -0,0039 \\
	\end{bmatrix}
\end{equation}
%